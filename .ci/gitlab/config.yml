# THIS FILE IS AUTOGENERATED -- DO NOT EDIT       #
# Edit and Re-run .ci/gitlab/config_template.py instead  #
stages:
  - images
  - cpp
  - python
  - headercheck

variables:
    GIT_SUBMODULE_STRATEGY: recursive
    TRAVIS_BRANCH: ${CI_COMMIT_REF_NAME}
    TRAVIS_COMMIT: ${CI_COMMIT_SHA}
    MY_MODULE: dune-xt
    CCACHE_BASEDIR: ${CI_PROJECT_DIR}
    CCACHE_DIR: "${CI_PROJECT_DIR}/.ccache"
    CCACHE_COMPILERCHECK: content

cache:
  key: "$CI_JOB_NAME"
  paths:
    - .ccache

.image_builder:
    tags:
      - docker-in-docker
      - long execution time
    stage: images
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    rules:
        - if: '$CI_COMMIT_REF_NAME =~ /^staging.*/'
          when: never
        - when: on_success
    retry:
        max: 2
        when:
            - always
    image: docker:19.03.12
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2
        IMAGE: $CI_REGISTRY/ag-ohlberger/dune-community/dune-xt/ci_testing_${CI_IMAGE}:${CI_COMMIT_SHORT_SHA}
    before_script:
      - |
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        apk --update add py3-pip openssh-client rsync git file bash python3 curl
        pip3 install -U docker jinja2 docopt

        export BASEIMAGE="${MY_MODULE}-testing_${CI_IMAGE}:${CI_COMMIT_REF_NAME/\//_}"
        # get image with fallback to master branch of the super repo
        docker pull dunecommunity/${BASEIMAGE} || export BASEIMAGE="${MY_MODULE}-testing_${CI_IMAGE}:master" ; docker pull dunecommunity/${BASEIMAGE}
    script:
      - |
        git submodule update --init --recursive
        docker build --build-arg BASE=${BASEIMAGE} -t ${IMAGE} -f .ci/gitlab/Dockerfile .
        docker push ${IMAGE}
    services:
        - docker:dind
    environment:
        name: unsafe

.subdir-test:
    tags:
      - long execution time
    stage: test
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    rules:
        - if: '$CI_COMMIT_REF_NAME =~ /^staging.*/'
          when: never
        - when: on_success
    retry:
        max: 2
        when:
            - always
    image: $CI_REGISTRY/ag-ohlberger/dune-community/dune-xt/ci_testing_${CI_IMAGE}:${CI_COMMIT_SHORT_SHA}

    before_script:
      - |
        mkdir /home/dune-ci/testresults && chmod -R 777 /home/dune-ci/testresults
        [[ -f ./.gitsuper ]] && echo "Please remove .gitsuper from the repo" && exit 1
        ccache --zero-stats || true
    after_script:
      - ccache --show-stats
    artifacts:
      reports:
        junit: '/home/dune-ci/testresults/*xml'
    environment:
        name: unsafe

debian-unstable_gcc_full:
    extends: .image_builder
    variables:
        CI_IMAGE: debian-unstable_gcc_full
debian_gcc_full:
    extends: .image_builder
    variables:
        CI_IMAGE: debian_gcc_full
debian_clang_full:
    extends: .image_builder
    variables:
        CI_IMAGE: debian_clang_full



common unstable_gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: common
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

common unstable_gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: common
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

common unstable_gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: common
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

grid unstable_gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: grid
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

grid unstable_gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: grid
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

grid unstable_gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: grid
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

functions unstable_gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: functions
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

functions unstable_gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: functions
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

functions unstable_gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: functions
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

la unstable_gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: la
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

la unstable_gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: la
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

la unstable_gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: la
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

common gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: common
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

common gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: common
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

common gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: common
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

grid gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: grid
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

grid gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: grid
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

grid gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: grid
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

functions gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: functions
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

functions gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: functions
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

functions gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: functions
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

la gcc_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: la
    tags:
        - dustin
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

la gcc_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: la
    tags:
        - dustin
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

la gcc_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_gcc_full
        TESTS_MODULE_SUBDIR: la
    tags:
        - dustin
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

common clang_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: common
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

common clang_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: common
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

common clang_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: common
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

grid clang_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: grid
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

grid clang_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: grid
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

grid clang_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: grid
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

functions clang_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: functions
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

functions clang_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: functions
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

functions clang_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: functions
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

la clang_full cpp:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: la
    stage: cpp
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash

la clang_full python:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: la
    stage: python
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

la clang_full headercheck:
    extends: .subdir-test
    variables:
        CI_IMAGE: debian_clang_full
        TESTS_MODULE_SUBDIR: la
    stage: headercheck
    script:
          - /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_headercheck.bash

