# THIS FILE IS AUTOGENERATED -- DO NOT EDIT       #
# Edit and Re-run .ci/gitlab/config_tpl.py instead  #
stages:
  - test

variables:
    GIT_SUBMODULE_STRATEGY: recursive
    TRAVIS_BRANCH: ${CI_COMMIT_REF_NAME}
    TRAVIS_COMMIT: ${CI_COMMIT_SHA}
    MY_MODULE: dune-xt

.subdir-test:
    tags:
      - docker-in-docker
      - long execution time
    stage: test
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    only: ['branches', 'tags', 'triggers', 'merge-requests']
    except:
        - /^staging/.*$/i
    retry:
        max: 2
        when:
            - always
    image: docker:stable
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2
    before_script:
      - |
        apk --update add openssh-client rsync git file bash python3 curl
        curl -o /tmp/env https://raw.githubusercontent.com/codecov/codecov-bash/master/env
        export ci_env=$(bash /tmp/env)
        echo 999999999999999999999999999999999999999999999999999999999999
        echo ${ci_env}
        echo 999999999999999999999999999999999999999999999999999999999999
        pip3 install -U docker jinja2 docopt

        export BASEIMAGE="${MY_MODULE}-testing_${DOCKER_TAG}:${CI_COMMIT_REF_NAME/\//_}"
        export IMAGE="dunecommunity/ci_${MY_MODULE}-testing_${DOCKER_TAG}:${CI_COMMIT_SHA}"
        # get image with fallback to master branch of the super repo
        docker pull dunecommunity/${BASEIMAGE} || export BASEIMAGE="${MY_MODULE}-testing_${DOCKER_TAG}:master" ; docker pull dunecommunity/${BASEIMAGE}
        export ENV_FILE=${HOME}/env
        mkdir ${CI_PROJECT_DIR}/testresults && chmod -R 777 ${CI_PROJECT_DIR}/testresults
        DOCKER_RUN="docker run -v ${CI_PROJECT_DIR}/testresults:/home/dune-ci/testresults --env-file ${ENV_FILE} ${ci_env} ${IMAGE}"
        git submodule update --init --recursive
        docker build --build-arg BASE=${BASEIMAGE} -t ${IMAGE} -f .ci/shared/docker/ci_run/Dockerfile .
    script:
      - |
        [[ -f ./.gitsuper ]] && echo "Please remove .gitsuper from the repo" && exit 1
        python3 ./.ci/shared/scripts/make_env_file.py
        ${DOCKER_RUN} /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_cpp.bash
        ${DOCKER_RUN} /home/dune-ci/src/${MY_MODULE}/.ci/shared/scripts/test_python.bash

    after_script:
      - |
        export IMAGE="dunecommunity/ci_${MY_MODULE}-testing_${DOCKER_TAG}:${CI_COMMIT_SHA}"
        echo $DOCKER_PW | docker login --username="$DOCKER_USER" --password-stdin
        docker push ${IMAGE}
    artifacts:
      reports:
        junit: '${CI_PROJECT_DIR}/testresults/*xml'
    services:
        - docker:dind
    environment:
        name: unsafe

common unstable_gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: common
grid unstable_gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: grid
functions unstable_gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: functions
la unstable_gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian-unstable_gcc_full
        TESTS_MODULE_SUBDIR: la
common gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_gcc_full
        TESTS_MODULE_SUBDIR: common
grid gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_gcc_full
        TESTS_MODULE_SUBDIR: grid
functions gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_gcc_full
        TESTS_MODULE_SUBDIR: functions
la gcc_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_gcc_full
        TESTS_MODULE_SUBDIR: la
common clang_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_clang_full
        TESTS_MODULE_SUBDIR: common
grid clang_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_clang_full
        TESTS_MODULE_SUBDIR: grid
functions clang_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_clang_full
        TESTS_MODULE_SUBDIR: functions
la clang_full:
    extends: .subdir-test
    variables:
        DOCKER_TAG: debian_clang_full
        TESTS_MODULE_SUBDIR: la
