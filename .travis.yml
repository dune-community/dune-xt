sudo: false
language: cpp
compiler:
  - gcc
  - clang

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    - boost-latest
    - george-edison55-precise-backports
    - llvm-toolchain-precise-3.7
    packages:
    - gcc-4.8
    - g++-4.8
    - clang
    - cmake
    - cmake-data
    - doxygen
    - texlive-base
    - python-virtualenv
    - libboost1.55-all-dev
    - python-pip
    - python3-pip
    - libtbb-dev

before_install:
  - if [ "$CXX" = "g++" ]; then export CXX="g++-4.8" CC="gcc-4.8"; fi
  - cd $HOME
  - test -d src || git clone --branch=travis http://users.dune-project.org/repositories/projects/dune-stuff-demos.git src
  - cd src
  - git submodule update --init --recursive
  - cp config.opts/travis ~/travis.opts
  - echo "removing modules ${MODULES_TO_DELETE}"
  - test x${MODULES_TO_DELETE} = x || rm -r ${MODULES_TO_DELETE}
  # ensures dune-stuff from travis own checkout is used
  - rm -rf dune-stuff
  - ./dune-common/bin/dunecontrol --opts=~/travis.opts all

# command to install dependencies
install:
  - if [ "$CXX" = "g++" ]; then export CXX="g++-4.8" CC="gcc-4.8"; fi
  - cd $HOME/src
  - pip install -U --user pip
  - ./dune-common/bin/dunecontrol --opts=config.opts/travis make install > /dev/null
  - rm -rf ~/{dune_build,src}

# # command to run tests
script:
    - cd ${TRAVIS_BUILD_DIR}
    - ~/dune/bin/dunecontrol --opts=~/travis.opts --only=dune-stuff all
    - ~/dune/bin/dunecontrol --opts=~/travis.opts --only=dune-stuff bexec make test -k
    - ~/dune/bin/dunecontrol --opts=~/travis.opts --only=dune-stuff bexec make headercheck -k

notifications:
  email:
    on_success: change
    on_failure: change

#after_success:
#- coveralls

branches:
  except:
    - gh-pages

before_cache:
  - rm -rf ~/build/dune-stuff

cache:
  directories:
    - $HOME/dune

os:
  - linux
  - osx

matrix:
  allow_failures:
    - os: osx

env:
  global:
    #- CAMPFIRE_TOKEN=abc123
  matrix:
    - MODULES_TO_DELETE="dune-fem dune-pdelab dune-typetree dune-grid dune-istl dune-python dune-testtools"
    - MODULES_TO_DELETE="dune-fem dune-pdelab dune-typetree"
    - USE_ALL_MODULES_IN_SUPER_REPO
